<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haskin</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --sidebar-bg: #f7f9fc;
            --primary-color: #3390ec;
            --secondary-bg: #ffffff;
            --border-color: #dfe1e5;
            --message-out: #eeffde;
            --message-in: #f2f2f2;
            --input-bg: #f4f4f5;
            --nav-height: 60px;
            --danger-color: #ff4444;
            --like-color: #e91e63;
            --notification-dot: #ff3b30;
            --verified-color: #3390ec;
            --status-bg: #eef3f8;
            --status-text: #3390ec;
            --top-post-bg: linear-gradient(135deg, #fff6b7 0%, #f6e6b4 100%);
        }

        [data-theme="dark"] {
            --bg-color: #0f0f0f;
            --text-color: #ffffff;
            --sidebar-bg: #1c1c1d;
            --primary-color: #8774e1;
            --secondary-bg: #212121;
            --border-color: #2b2b2b;
            --message-out: #8774e1;
            --message-in: #212121;
            --input-bg: #1c1c1d;
            --verified-color: #8774e1;
            --status-bg: #2b2b2b;
            --status-text: #aaaaaa;
            --top-post-bg: linear-gradient(135deg, #423806 0%, #2e2808 100%);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; display: flex; overflow: hidden; }
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-fill { fill: currentColor; stroke: none; }
        
        .action-btn { padding: 10px 20px; border-radius: 12px; border: none; background: var(--primary-color); color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-danger { background: var(--danger-color); }
        .btn-sec { background: var(--input-bg); color: var(--text-color); }

        input, textarea, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-color); box-sizing: border-box; font-family: inherit; font-size: 16px; outline: none;}

        /* FAB (Floating Action Button) */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: var(--primary-color); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        @media (min-width: 769px) { .fab { bottom: 40px; right: 40px; } }

        /* Splash */
        #splash { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .splash-logo { font-size: 3em; font-weight: 900; color:var(--primary-color); }

        /* Auth */
        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .auth-box { background: var(--secondary-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 350px; text-align: center; }
        .password-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6; }

        /* App Layout */
        #app-screen { display: none; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .main { flex: 1; background: var(--bg-color); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .view { display: none; padding: 15px; overflow-y: auto; height: 100%; padding-bottom: 100px; box-sizing: border-box; }
        .view.active { display: block; }

        .nav-item { padding: 12px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; color: var(--text-color); gap: 15px; font-weight: 500; transition: 0.2s; }
        .nav-item:hover { background: rgba(0,0,0,0.05); }
        .nav-item.active { background: rgba(var(--primary-color), 0.1); color: var(--primary-color); font-weight: 700; }
        .nav-item.active svg { stroke: var(--primary-color); }
        .badge { background: var(--notification-dot); width: 8px; height: 8px; border-radius: 50%; margin-left: auto; display: none;}

        /* Components */
        .card { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 12px; }
        .avatar { border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .av-40 { width: 40px; height: 40px; }
        .av-80 { width: 80px; height: 80px; }
        .user-row { display: flex; align-items: center; gap: 10px; }
        
        /* Post */
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
        .verified-badge { width: 16px; height: 16px; color: var(--verified-color); fill: currentColor; margin-left: 4px; vertical-align: text-bottom;}
        .status-pill { font-size: 11px; background: var(--status-bg); color: var(--status-text); padding: 2px 6px; border-radius: 6px; font-weight: bold; margin-left: 5px; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border-color); }
        .post-actions { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .act-btn { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; font-weight: 500; color: gray; }
        .act-btn.liked { color: var(--like-color); }
        .act-btn.liked svg { fill: var(--like-color); stroke: var(--like-color); }

        .top-post-banner { background: var(--top-post-bg); border: 2px solid gold; position: relative; overflow: hidden; }
        .top-label { position: absolute; top: 0; right: 0; background: gold; color: black; font-weight: bold; font-size: 10px; padding: 2px 8px; border-bottom-left-radius: 8px; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; white-space: nowrap; font-size: 14px; }
        .tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Modals */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
        .modal { background: var(--secondary-bg); width: 90%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.2em; font-weight: bold; }

        /* Chat */
        .msg-area { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 15px; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--message-out); border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: var(--message-in); border-bottom-left-radius: 4px; }

        /* Mobile Nav */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; justify-content: space-around; border-top: 1px solid var(--border-color); padding: 0; z-index: 100; align-items: center; }
            .sidebar h2, .desk-label { display: none; }
            .nav-item { flex-direction: column; gap: 2px; padding: 5px; font-size: 10px; margin: 0; background: none !important; }
            .nav-item svg { width: 24px; height: 24px; }
            #view-chat-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; padding: 0; display: none; flex-direction: column; }
            .fab { bottom: 70px; }
        }
    </style>
</head>
<body>

<div id="splash"><div class="splash-logo">Haskin</div></div>

<div id="auth-screen">
    <div class="auth-box" id="login-box">
        <h1 style="color:var(--primary-color)">–í—Ö–æ–¥</h1>
        <input type="text" id="login-user" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º">
        <div class="password-wrapper">
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <span class="toggle-pass" onclick="ui.togglePass('login-pass')">üëÅÔ∏è</span>
        </div>
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.login()">–í–æ–π—Ç–∏</button>
        <p style="cursor:pointer; color:gray" onclick="ui.toggleAuth('reg')">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
    </div>
    <div class="auth-box hidden" id="reg-box">
        <h1 style="color:var(--primary-color)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <input type="text" id="reg-user" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (–∞–Ω–≥–ª)">
        <input type="text" id="reg-name" placeholder="–ò–º—è">
        <div class="password-wrapper"><input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å"><span class="toggle-pass" onclick="ui.togglePass('reg-pass')">üëÅÔ∏è</span></div>
        <div class="password-wrapper"><input type="password" id="reg-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è"><span class="toggle-pass" onclick="ui.togglePass('reg-pass2')">üëÅÔ∏è</span></div>
        <div style="border:1px solid #ccc; padding:10px; border-radius:10px; margin:5px 0;">
            <small>–ö–∞–ø—á–∞: <span id="captcha-task"></span></small>
            <input type="number" id="reg-captcha" placeholder="–û—Ç–≤–µ—Ç">
        </div>
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.register()">–°–æ–∑–¥–∞—Ç—å</button>
        <p style="cursor:pointer; color:gray" onclick="ui.toggleAuth('login')">–ù–∞–∑–∞–¥</p>
    </div>
</div>

<div id="create-post-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–ù–æ–≤—ã–π –ø–æ—Å—Ç <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <textarea id="post-text" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <div id="post-img-preview" class="hidden" style="position:relative; margin-bottom:10px;">
            <img id="preview-img-el" style="width:100%; border-radius:10px;">
            <div onclick="app.clearImg()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border-radius:50%; width:24px; height:24px; text-align:center; cursor:pointer;">√ó</div>
        </div>
        <div style="display:flex; justify-content:space-between;">
            <label class="action-btn btn-sec">üì∑<input type="file" hidden accept="image/*" onchange="app.handleImg(this)"></label>
            <button class="action-btn" onclick="app.createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="create-group-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <input type="text" id="group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input type="text" id="group-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<div id="comments-modal" class="modal-overlay">
    <div class="modal" style="height:70vh">
        <div class="modal-head">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <div id="comments-list" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å...">
            <button class="action-btn" onclick="app.sendComment()">‚û§</button>
        </div>
    </div>
</div>

<div id="verify-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <input id="v-real" placeholder="–§–ò–û / –õ–∏—á–Ω–æ—Å—Ç—å">
        <input id="v-links" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏">
        <textarea id="v-reason" placeholder="–ü–æ—á–µ–º—É –Ω—É–∂–Ω–∞ –≥–∞–ª–æ—á–∫–∞?"></textarea>
        <button class="action-btn" onclick="app.reqVerify()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div id="app-screen">
    <div class="fab" onclick="document.getElementById('create-post-modal').style.display='flex'">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    </div>

    <div class="sidebar">
        <h2 style="color:var(--primary-color); margin-bottom:30px; padding-left:10px;" class="desk-label">Haskin</h2>
        
        <div class="nav-item active" onclick="ui.nav('feed')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="desk-label">–õ–µ–Ω—Ç–∞</span>
        </div>
        <div class="nav-item" onclick="ui.nav('search')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span class="desk-label">–ü–æ–∏—Å–∫</span>
        </div>
        <div class="nav-item" onclick="ui.nav('groups')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span class="desk-label">–ì—Ä—É–ø–ø—ã</span>
        </div>
        <div class="nav-item" onclick="ui.nav('chats')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span class="desk-label">–ß–∞—Ç—ã</span>
        </div>
        <div class="nav-item" onclick="ui.nav('notifs')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span class="desk-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            <div class="badge" id="notif-badge"></div>
        </div>
        <div class="nav-item" onclick="ui.nav('profile', app.user.username)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span class="desk-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="nav-item hidden" id="nav-admin" onclick="ui.nav('admin')">
            <svg class="icon" viewBox="0 0 24 24" style="stroke:red"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span class="desk-label" style="color:red">–ê–¥–º–∏–Ω–∫–∞</span>
        </div>
        <div class="nav-item" onclick="ui.nav('settings')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span class="desk-label">–ú–µ–Ω—é</span>
        </div>
    </div>

    <div class="main">
        <div id="view-feed" class="view active">
            <h2 style="padding:0 15px; color:var(--primary-color)">–õ–µ–Ω—Ç–∞</h2>
            <div id="feed-content"></div>
        </div>

        <div id="view-groups" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>–°–æ–æ–±—â–µ—Å—Ç–≤–∞</h2>
                <button class="action-btn" style="padding:5px 15px; font-size:12px;" onclick="document.getElementById('create-group-modal').style.display='flex'">+ –°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div id="groups-list"></div>
        </div>

        <div id="view-search" class="view">
            <h2>–ü–æ–∏—Å–∫</h2>
            <input placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="app.search(this.value)">
            <div id="search-res" style="margin-top:10px;"></div>
        </div>

        <div id="view-profile" class="view">
            <div id="profile-head"></div>
            <div class="tabs" style="margin-top:10px; padding:0 15px;">
                <div class="tab active">–ü–æ—Å—Ç—ã</div>
            </div>
            <div id="profile-posts"></div>
        </div>

        <div id="view-chats" class="view">
            <h2>–ß–∞—Ç—ã</h2>
            <div id="chats-list"></div>
        </div>
        
        <div id="view-chat-room" class="view" style="padding:0; display:none; flex-direction:column; z-index:2000;">
            <div style="padding:10px; background:var(--secondary-bg); border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:10px;">
                <button onclick="ui.nav('chats')" style="border:none; background:none; font-size:24px; color:var(--text-color);">‚Üê</button>
                <b id="chat-title">User</b>
            </div>
            <div id="msg-container" class="msg-area"></div>
            <div style="padding:10px; background:var(--secondary-bg); display:flex; gap:10px;">
                <input id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="action-btn" onclick="app.sendMsg()">‚û§</button>
            </div>
        </div>

        <div id="view-notifs" class="view">
            <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <div id="notifs-list"></div>
        </div>

        <div id="view-settings" class="view">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="tabs">
                <button class="tab active" onclick="ui.setTab('acc', this)">–ê–∫–∫–∞—É–Ω—Ç</button>
                <button class="tab" onclick="ui.setTab('ui', this)">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
                <button class="tab" onclick="ui.setTab('priv', this)">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</button>
            </div>
            
            <div id="set-acc" class="set-page">
                <div class="card">
                    <h3>–î–∞–Ω–Ω—ã–µ</h3>
                    <input id="edit-name" placeholder="–ò–º—è">
                    <textarea id="edit-bio" placeholder="–û —Å–µ–±–µ"></textarea>
                    <p>–°—Ç–∞—Ç—É—Å:</p>
                    <select id="edit-status"></select>
                    <label class="action-btn btn-sec" style="margin-top:10px">–ê–≤–∞—Ç–∞—Ä<input type="file" hidden accept="image/*" onchange="app.handleAvatar(this)"></label>
                    <button class="action-btn" style="margin-top:10px; width:100%" onclick="app.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <div class="card">
                    <h3>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
                    <button class="action-btn" onclick="document.getElementById('verify-modal').style.display='flex'">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–∞–ª–æ—á–∫—É</button>
                </div>
                <button class="action-btn btn-danger" style="width:100%" onclick="app.logout()">–í—ã–π—Ç–∏</button>
            </div>

            <div id="set-ui" class="set-page hidden">
                <div class="card">
                    <label class="user-row">
                        <input type="checkbox" id="theme-switch" onchange="ui.theme()"> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
                    </label>
                </div>
            </div>

            <div id="set-priv" class="set-page hidden">
                <div class="card">
                    <h3>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h3>
                    <label class="user-row">
                        <input type="checkbox" id="private-switch" onchange="app.togglePrivate()"> üîí –ó–∞–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                    </label>
                    <p style="font-size:12px; color:gray">–¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —É–≤–∏–¥—è—Ç –≤–∞—à–∏ –ø–æ—Å—Ç—ã.</p>
                </div>
                <div class="card">
                    <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                    <input type="password" id="ch-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    <button class="action-btn" onclick="app.changePass()">–°–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view">
            <h2 style="color:red">–ê–¥–º–∏–Ω–∫–∞</h2>
            <div class="tabs">
                <button class="tab active" onclick="admin.tab('users')">–Æ–∑–µ—Ä—ã</button>
                <button class="tab" onclick="admin.tab('verify')">–ó–∞—è–≤–∫–∏</button>
                <button class="tab" onclick="admin.tab('words')">–§–∏–ª—å—Ç—Ä</button>
            </div>
            <div id="adm-content"></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBCcBSZx6kAFGwTscJlfDuiQILGZDaVN4g",
    authDomain: "mysocnet-34ee9.firebaseapp.com",
    projectId: "mysocnet-34ee9",
    storageBucket: "mysocnet-34ee9.firebasestorage.app",
    messagingSenderId: "82449086862",
    appId: "1:82449086862:web:e77a61b33a54be97a00cdf",
    measurementId: "G-4Z2SMZS5N4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// SVGs
const ICONS = {
    like: '<svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
    comment: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    share: '<svg class="icon" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>',
    trash: '<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
    verify: '<svg class="verified-badge" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
    lock: '<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'
};

// State
let currentUser = null;
let listeners = {};
let tempImg = null;
let tempAv = null;
let curChat = null;
let curPost = null;
let captchaAns = 0;
let lastPostTime = 0;

// Utils
const compress = (file, cb) => {
    const r = new FileReader(); r.readAsDataURL(file);
    r.onload = e => {
        const i = new Image(); i.src = e.target.result;
        i.onload = () => {
            const c = document.createElement('canvas');
            const max = 800; let w=i.width, h=i.height;
            if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
            c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h);
            cb(c.toDataURL('image/jpeg', 0.8));
        }
    }
};
const getAv = (u, sz) => `<img src="${u.avatar||'https://via.placeholder.com/80'}" class="avatar ${sz}">`;

window.ui = {
    nav: (v, p) => {
        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('view-'+(v==='admin'?'admin':v)).classList.add('active');
        
        // Highlight logic
        const map = {'feed':0, 'search':1, 'groups':2, 'chats':3, 'notifs':4, 'profile':5, 'admin':6, 'settings':7};
        if(map[v]!==undefined) document.querySelectorAll('.nav-item')[map[v]].classList.add('active');
        
        if(v==='feed') app.loadFeed();
        if(v==='chats') app.loadChats();
        if(v==='groups') app.loadGroups();
        if(v==='notifs') app.listenNotifs();
        if(v==='profile') app.loadProfile(p);
        if(v==='admin') admin.tab('users');
    },
    toggleAuth: m => {
        document.getElementById('login-box').classList.toggle('hidden', m!=='login');
        document.getElementById('reg-box').classList.toggle('hidden', m!=='reg');
        if(m==='reg') app.genCaptcha();
    },
    togglePass: id => {
        const el = document.getElementById(id);
        el.type = el.type==='password'?'text':'password';
    },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'),
    theme: () => {
        const d = document.getElementById('theme-switch').checked;
        document.documentElement.setAttribute('data-theme', d?'dark':'');
        localStorage.setItem('theme', d?'dark':'');
    },
    setTab: (t, btn) => {
        document.querySelectorAll('.set-page').forEach(e=>e.classList.add('hidden'));
        document.getElementById('set-'+t).classList.remove('hidden');
        btn.parentElement.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        btn.classList.add('active');
    }
};

window.app = {
    init: async () => {
        if(localStorage.getItem('theme')==='dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-switch').checked = true;
        }
        setTimeout(async () => {
            const u = localStorage.getItem('user');
            if(u) {
                try {
                    const s = await getDoc(doc(db, 'users', u));
                    if(s.exists()) {
                        currentUser = s.data();
                        if(currentUser.isBanned) return localStorage.clear() || location.reload();
                        document.getElementById('auth-screen').style.display='none';
                        document.getElementById('app-screen').style.display='block';
                        if(currentUser.isAdmin) document.getElementById('nav-admin').classList.remove('hidden');
                        ui.nav('feed');
                        app.checkAchievs();
                    } else ui.toggleAuth('login');
                } catch(e){ ui.toggleAuth('login'); }
            } else ui.toggleAuth('login');
            document.getElementById('splash').style.display='none';
        }, 1000);
    },

    genCaptcha: () => {
        const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
        captchaAns = a+b;
        document.getElementById('captcha-task').innerText = `${a} + ${b}`;
    },

    register: async () => {
        const u = document.getElementById('reg-user').value.toLowerCase().trim();
        const n = document.getElementById('reg-name').value.trim();
        const p1 = document.getElementById('reg-pass').value;
        const p2 = document.getElementById('reg-pass2').value;
        const c = parseInt(document.getElementById('reg-captcha').value);
        
        if(!u || !n || !p1) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        if(p1!==p2) return alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        if(c!==captchaAns) return alert('–ö–∞–ø—á–∞ –Ω–µ–≤–µ—Ä–Ω–∞');
        
        try {
            const r = doc(db, 'users', u);
            if((await getDoc(r)).exists()) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç');
            await setDoc(r, {
                username: u, name: n, password: p1,
                followers: [], following: [], blocked: [], 
                isAdmin: u==='haskin', isBanned: false, isPrivate: false,
                requests: [], groups: [], bio: '', status: '',
                unlocked: [], avatar: '', createdAt: Date.now()
            });
            alert('–ì–æ—Ç–æ–≤–æ'); ui.toggleAuth('login');
        } catch(e) { alert('–û—à–∏–±–∫–∞'); }
    },

    login: async () => {
        const u = document.getElementById('login-user').value.toLowerCase().trim();
        const p = document.getElementById('login-pass').value;
        const s = await getDoc(doc(db, 'users', u));
        if(s.exists() && s.data().password === p) {
            if(s.data().isBanned) return alert('–ë–∞–Ω');
            localStorage.setItem('user', u);
            location.reload();
        } else alert('–ù–µ–≤–µ—Ä–Ω–æ');
    },
    logout: () => { localStorage.clear(); location.reload(); },

    // --- Core Features ---
    createPost: async () => {
        if(Date.now()-lastPostTime < 5000) return alert('–ù–µ —Å–ø–µ—à–∏!');
        const txt = document.getElementById('post-text').value.trim();
        if(!txt && !tempImg) return;
        
        const p = {
            author: currentUser.username, name: currentUser.name,
            content: txt, image: tempImg || null,
            likes: [], createdAt: Date.now(),
            verified: currentUser.isVerified || false,
            status: currentUser.status || '',
            avatar: currentUser.avatar || ''
        };
        await addDoc(collection(db, 'posts'), p);
        lastPostTime = Date.now();
        document.getElementById('post-text').value='';
        app.clearImg(); ui.closeModals();
        app.checkAchievs();
    },

    repost: async (postId) => {
        if(!confirm('–†–µ–ø–æ—Å—Ç–Ω—É—Ç—å –∫ —Å–µ–±–µ?')) return;
        const orig = (await getDoc(doc(db, 'posts', postId))).data();
        await addDoc(collection(db, 'posts'), {
            author: currentUser.username, name: currentUser.name,
            content: `üì¢ –†–µ–ø–æ—Å—Ç –æ—Ç @${orig.author}:\n\n${orig.content}`,
            image: orig.image, likes: [], createdAt: Date.now(),
            verified: currentUser.isVerified, status: currentUser.status,
            avatar: currentUser.avatar, isRepost: true
        });
        alert('–†–µ–ø–æ—Å—Ç–Ω—É—Ç!');
    },

    loadFeed: async () => {
        const c = document.getElementById('feed-content'); c.innerHTML = '';
        
        // 1. Get Top Post of Day
        const yesterday = Date.now() - 86400000;
        const qTop = query(collection(db, 'posts'), where('createdAt', '>', yesterday), orderBy('createdAt', 'desc')); // client-side sort for likes later
        const snaps = await getDocs(qTop);
        let topPost = null;
        let maxLikes = -1;
        
        const posts = [];
        snaps.forEach(d => {
            const p = d.data(); p.id = d.id;
            if(p.likes.length > maxLikes) { maxLikes = p.likes.length; topPost = p; }
            posts.push(p);
        });

        // Render Top Post
        if(topPost && maxLikes > 0) {
            c.innerHTML += app.renderPost(topPost, true);
        }

        // Render Feed (Subs + Recommendations)
        // Note: Firestore logic simplified. We show all posts but client-side filter blocked.
        // For recommendations: show random posts from non-followed.
        
        if(listeners.feed) listeners.feed();
        const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(50));
        listeners.feed = onSnapshot(q, s => {
            // Clear but keep top post if exists
            const topHtml = topPost && maxLikes > 0 ? app.renderPost(topPost, true) : '';
            let html = topHtml;
            
            s.forEach(d => {
                const p = d.data(); p.id = d.id;
                if(currentUser.blocked.includes(p.author)) return;
                if(topPost && p.id === topPost.id) return; // Don't duplicate
                html += app.renderPost(p);
            });
            c.innerHTML = html;
        });
    },

    renderPost: (p, isTop=false) => {
        const isLiked = p.likes.includes(currentUser.username);
        const isMine = p.author === currentUser.username;
        return `
        <div class="card ${isTop?'top-post-banner':''}">
            ${isTop ? '<div class="top-label">üëë –¢–û–ü –î–ù–Ø</div>' : ''}
            <div class="post-header" onclick="ui.nav('profile','${p.author}')">
                ${getAv(p, 'av-40')}
                <div>
                    <div style="font-weight:bold; display:flex; align-items:center;">
                        ${p.name} ${p.verified?ICONS.verify:''} 
                        ${p.status?`<span class="status-pill">${p.status}</span>`:''}
                    </div>
                    <div style="font-size:12px; color:gray">@${p.author} ‚Ä¢ ${new Date(p.createdAt).toLocaleDateString()}</div>
                </div>
            </div>
            <div style="white-space:pre-wrap">${p.content}</div>
            ${p.image ? `<img src="${p.image}" class="post-img">` : ''}
            <div class="post-actions">
                <div class="act-btn ${isLiked?'liked':''}" onclick="app.like('${p.id}', '${p.author}')">
                    ${ICONS.like} ${p.likes.length}
                </div>
                <div class="act-btn" onclick="app.openComs('${p.id}', '${p.author}')">
                    ${ICONS.comment}
                </div>
                <div class="act-btn" onclick="app.repost('${p.id}')">
                    ${ICONS.share}
                </div>
                ${isMine || currentUser.isAdmin ? `<div class="act-btn" style="margin-left:auto; color:red" onclick="app.delPost('${p.id}')">${ICONS.trash}</div>` : ''}
            </div>
        </div>`;
    },

    // --- Profile & Groups ---
    loadProfile: async (u) => {
        const c = document.getElementById('profile-head');
        c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const s = await getDoc(doc(db, 'users', u));
        
        if(s.exists()) { // User Profile
            const user = s.data();
            const isMe = u === currentUser.username;
            const isFollow = currentUser.following.includes(u);
            const isClosed = user.isPrivate && !isMe && !isFollow;
            
            // Render Header
            let btn = '';
            if(isMe) btn = `<button class="action-btn" onclick="ui.nav('settings')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
            else {
                if(isFollow) btn = `<button class="action-btn btn-sec" onclick="app.follow('${u}')">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button> <button class="action-btn" onclick="ui.nav('chat-room','${u}')">–ß–∞—Ç</button>`;
                else if (user.isPrivate) {
                    const sent = user.requests && user.requests.includes(currentUser.username);
                    btn = `<button class="action-btn" onclick="app.reqFollow('${u}')">${sent?'–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω':'üîí –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'}</button>`;
                } else {
                    btn = `<button class="action-btn" onclick="app.follow('${u}')">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>`;
                }
            }

            c.innerHTML = `
                <div class="card" style="text-align:center">
                    ${getAv(user, 'av-80')}
                    <h2 style="margin:5px 0">${user.name} ${user.isVerified?ICONS.verify:''}</h2>
                    <div style="color:gray">@${user.username} ${user.status?`‚Ä¢ <span class="status-pill">${user.status}</span>`:''}</div>
                    <p>${user.bio||''}</p>
                    <div style="display:flex; justify-content:center; gap:20px; margin:10px 0;">
                        <b>${user.followers.length} <span style="font-weight:normal; color:gray">–ø–æ–¥–ø.</span></b>
                        <b>${user.following.length} <span style="font-weight:normal; color:gray">–ø–æ–¥–ø–∏—Å–∫–∏</span></b>
                    </div>
                    ${btn}
                </div>
            `;

            const pc = document.getElementById('profile-posts');
            if(isClosed) {
                pc.innerHTML = `<div style="text-align:center; padding:20px; color:gray">${ICONS.lock}<br>–≠—Ç–æ –∑–∞–∫—Ä—ã—Ç—ã–π –∞–∫–∫–∞—É–Ω—Ç</div>`;
            } else {
                // Load Posts
                const q = query(collection(db, 'posts'), where('author', '==', u), orderBy('createdAt', 'desc'));
                const ps = await getDocs(q);
                pc.innerHTML = '';
                ps.forEach(d => pc.innerHTML += app.renderPost({...d.data(), id:d.id}));
            }
        } else {
            // Maybe it's a Group?
            const g = await getDoc(doc(db, 'groups', u));
            if(g.exists()) {
                const group = g.data();
                const isMem = group.members.includes(currentUser.username);
                const isOwner = group.owner === currentUser.username;
                
                c.innerHTML = `
                    <div class="card" style="text-align:center">
                        <div class="avatar av-80" style="background:${varColor(group.name)}; display:inline-flex; align-items:center; justify-content:center; font-size:30px; color:white;">${group.name[0]}</div>
                        <h2>${group.name}</h2>
                        <p>${group.desc}</p>
                        <p style="color:gray">${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        ${isMem ? `<button class="action-btn btn-sec" onclick="app.joinGroup('${u}', false)">–í—ã–π—Ç–∏</button>` : `<button class="action-btn" onclick="app.joinGroup('${u}', true)">–í—Å—Ç—É–ø–∏—Ç—å</button>`}
                    </div>
                `;
                // Posts
                 const q = query(collection(db, 'posts'), where('author', '==', u), orderBy('createdAt', 'desc'));
                const ps = await getDocs(q);
                const pc = document.getElementById('profile-posts');
                pc.innerHTML = '';
                if(isOwner) pc.innerHTML = `<button class="action-btn" style="width:100%; margin-bottom:10px" onclick="document.getElementById('create-post-modal').style.display='flex'">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø—É</button>`;
                ps.forEach(d => pc.innerHTML += app.renderPost({...d.data(), id:d.id}));
            } else c.innerHTML = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
        }
    },

    createGroup: async () => {
        const n = document.getElementById('group-name').value.trim();
        const d = document.getElementById('group-desc').value;
        const id = 'public_' + Date.now();
        await setDoc(doc(db, 'groups', id), {
            id, name: n, desc: d, owner: currentUser.username, members: [currentUser.username]
        });
        await updateDoc(doc(db, 'users', currentUser.username), { groups: arrayUnion(id) });
        ui.closeModals();
        ui.nav('groups');
    },

    loadGroups: async () => {
        const c = document.getElementById('groups-list'); c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const q = query(collection(db, 'groups'), limit(20));
        const s = await getDocs(q);
        c.innerHTML = '';
        s.forEach(d => {
            const g = d.data();
            c.innerHTML += `
            <div class="card user-row" onclick="ui.nav('profile','${g.id}')">
                <div class="avatar av-40" style="background:${varColor(g.name)}; display:flex; align-items:center; justify-content:center; color:white;">${g.name[0]}</div>
                <div><b>${g.name}</b><br><small>${g.members.length} —É—á.</small></div>
            </div>`;
        });
    },

    joinGroup: async (gid, join) => {
        const ref = doc(db, 'groups', gid);
        if(join) await updateDoc(ref, { members: arrayUnion(currentUser.username) });
        else await updateDoc(ref, { members: arrayRemove(currentUser.username) });
        ui.nav('profile', gid);
    },

    // --- Actions ---
    like: async (pid, auth) => {
        const r = doc(db, 'posts', pid);
        const p = (await getDoc(r)).data();
        if(p.likes.includes(currentUser.username)) await updateDoc(r, {likes: arrayRemove(currentUser.username)});
        else {
            await updateDoc(r, {likes: arrayUnion(currentUser.username)});
            app.notify(auth, 'like', '–æ—Ü–µ–Ω–∏–ª –ø–æ—Å—Ç');
        }
    },
    follow: async (u) => {
        const me = doc(db, 'users', currentUser.username);
        const him = doc(db, 'users', u);
        if(currentUser.following.includes(u)) {
            await updateDoc(me, {following: arrayRemove(u)});
            await updateDoc(him, {followers: arrayRemove(currentUser.username)});
            currentUser.following = currentUser.following.filter(x=>x!==u);
        } else {
            await updateDoc(me, {following: arrayUnion(u)});
            await updateDoc(him, {followers: arrayUnion(currentUser.username)});
            currentUser.following.push(u);
            app.notify(u, 'sub', '–ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –≤–∞—Å');
        }
        ui.nav('profile', u);
        app.checkAchievs();
    },
    reqFollow: async (u) => {
        await updateDoc(doc(db, 'users', u), { requests: arrayUnion(currentUser.username) });
        app.notify(u, 'req', '—Ö–æ—á–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è');
        alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); ui.nav('profile', u);
    },
    acceptReq: async (u) => {
        await updateDoc(doc(db, 'users', currentUser.username), { requests: arrayRemove(u), followers: arrayUnion(u) });
        await updateDoc(doc(db, 'users', u), { following: arrayUnion(currentUser.username) });
        app.notify(u, 'msg', '–ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É');
        app.listenNotifs();
    },

    // --- Misc ---
    handleImg: el => { if(el.files[0]) compress(el.files[0], d=>{ tempImg=d; document.getElementById('preview-img-el').src=d; document.getElementById('post-img-preview').classList.remove('hidden'); }) },
    clearImg: () => { tempImg=null; document.getElementById('post-img-preview').classList.add('hidden'); },
    handleAvatar: el => { if(el.files[0]) compress(el.files[0], d=>{ tempAv=d; }) },
    
    saveProfile: async () => {
        const n = document.getElementById('edit-name').value;
        const b = document.getElementById('edit-bio').value;
        const s = document.getElementById('edit-status').value;
        const upd = { name:n, bio:b, status:s };
        if(tempAv) upd.avatar = tempAv;
        await updateDoc(doc(db, 'users', currentUser.username), upd);
        location.reload();
    },
    togglePrivate: async () => {
        const v = document.getElementById('private-switch').checked;
        await updateDoc(doc(db, 'users', currentUser.username), { isPrivate: v });
    },
    
    checkAchievs: async () => {
        // Simple logic for statuses
        const u = currentUser;
        const unlocked = u.unlocked || [];
        const posts = (await getDocs(query(collection(db,'posts'), where('author','==',u.username)))).size;
        
        const map = { '–ê–∫—Ç–∏–≤–Ω—ã–π': posts>=5, '–ü–∏—Å–∞—Ç–µ–ª—å': posts>=50, '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π': u.followers.length>=10 };
        let ch = false;
        for(let k in map) {
            if(map[k] && !unlocked.includes(k)) { unlocked.push(k); ch=true; app.notify(u.username, 'msg', `üèÜ –°—Ç–∞—Ç—É—Å: ${k}`); }
        }
        if(ch) await updateDoc(doc(db, 'users', u.username), { unlocked });
        
        // Fill select
        const sel = document.getElementById('edit-status');
        sel.innerHTML = '<option value="">–ù–µ—Ç</option>';
        unlocked.forEach(s => sel.innerHTML += `<option>${s}</option>`);
        sel.value = u.status;
    },

    search: async (v) => {
        if(!v) return;
        v = v.toLowerCase();
        const q = query(collection(db, 'users'), where('username', '>=', v), limit(5));
        const s = await getDocs(q);
        const c = document.getElementById('search-res'); c.innerHTML='';
        s.forEach(d => {
            const u = d.data();
            c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${u.username}')">${getAv(u,'av-40')} <b>${u.name}</b></div>`;
        });
    },

    notify: async (to, type, txt) => {
        if(to === currentUser.username) return;
        await addDoc(collection(db, 'users', to, 'notifications'), { type, text: txt, from: currentUser.username, time: Date.now(), read: false });
    },
    listenNotifs: () => {
        const q = query(collection(db, 'users', currentUser.username, 'notifications'), orderBy('time', 'desc'), limit(20));
        onSnapshot(q, s => {
            let n = 0; s.forEach(d => { if(!d.data().read) n++ });
            document.getElementById('notif-badge').style.display = n?'block':'none';
            if(document.getElementById('view-notifs').classList.contains('active')) {
                const c = document.getElementById('notifs-list'); c.innerHTML='';
                s.forEach(d => {
                    const x = d.data();
                    let act = '';
                    if(x.type === 'req') act = `<button class="action-btn" style="font-size:12px; padding:5px" onclick="app.acceptReq('${x.from}')">–ü—Ä–∏–Ω—è—Ç—å</button>`;
                    c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${x.from}')">
                        ${ICONS.lock} <div><b>@${x.from}</b> ${x.text}</div> ${act}
                    </div>`;
                });
            }
        });
    }
};

// Admin
window.admin = {
    tab: t => {
        document.getElementById('adm-content').innerHTML = t === 'users' ? '<input oninput="admin.s(this.value)" placeholder="–ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞..."><div id="adm-list"></div>' : '–ó–∞–≥—Ä—É–∑–∫–∞...';
        if(t==='verify') admin.loadV();
    },
    s: async v => {
        const s = await getDocs(query(collection(db,'users'), where('username','>=',v), limit(5)));
        const c = document.getElementById('adm-list'); c.innerHTML='';
        s.forEach(d=> {
            const u = d.data();
            c.innerHTML += `<div class="card"><b>${u.username}</b> <button onclick="admin.ban('${u.username}')">–ë–∞–Ω</button></div>`;
        });
    },
    loadV: async () => {
        const s = await getDocs(query(collection(db,'system','verifications','requests'), where('status','==','pending')));
        const c = document.getElementById('adm-content'); c.innerHTML = '';
        s.forEach(d => {
            const r = d.data();
            c.innerHTML += `<div class="card"><b>${r.username}</b>: ${r.realname}<br>${r.reason}<br><button onclick="admin.okV('${d.id}','${r.username}')">–î–∞</button></div>`;
        });
    },
    okV: async (id, u) => {
        await updateDoc(doc(db,'users',u), {isVerified:true});
        await updateDoc(doc(db,'system','verifications','requests',id), {status:'approved'});
        alert('OK'); admin.loadV();
    },
    ban: async u => { if(confirm('–ë–∞–Ω?')) await updateDoc(doc(db,'users',u), {isBanned:true}); }
};

const varColor = (str) => {
    let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${hash % 360}, 60%, 50%)`;
}

app.init();
</script>
</body>
</html>
