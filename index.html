<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haskin</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --sidebar-bg: #f7f9fc;
            --primary-color: #3390ec;
            --secondary-bg: #ffffff;
            --border-color: #dfe1e5;
            --message-out: #eeffde;
            --message-in: #f2f2f2;
            --input-bg: #f4f4f5;
            --nav-height: 60px;
            --danger-color: #ff4444;
            --like-color: #e91e63;
            --notification-dot: #ff3b30;
            --verified-color: #3390ec;
            --status-bg: #eef3f8;
            --status-text: #3390ec;
            --top-post-bg: linear-gradient(135deg, #fff6b7 0%, #f6e6b4 100%);
            --pinned-bg: #e3f2fd;
        }

        [data-theme="dark"] {
            --bg-color: #0f0f0f;
            --text-color: #ffffff;
            --sidebar-bg: #1c1c1d;
            --primary-color: #8774e1;
            --secondary-bg: #212121;
            --border-color: #2b2b2b;
            --message-out: #8774e1;
            --message-in: #212121;
            --input-bg: #1c1c1d;
            --verified-color: #8774e1;
            --status-bg: #2b2b2b;
            --status-text: #aaaaaa;
            --top-post-bg: linear-gradient(135deg, #423806 0%, #2e2808 100%);
            --pinned-bg: #19192b;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); height: 100dvh; display: flex; overflow: hidden; }
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        .action-btn { padding: 8px 16px; border-radius: 10px; border: none; background: var(--primary-color); color: white; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px; }
        .btn-danger { background: var(--danger-color); }
        .btn-sec { background: var(--input-bg); color: var(--text-color); }

        input, textarea, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid var(--border-color); border-radius: 10px; background: var(--input-bg); color: var(--text-color); box-sizing: border-box; font-family: inherit; font-size: 16px; outline: none;}

        .fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: var(--primary-color); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
        @media (min-width: 769px) { .fab { bottom: 40px; right: 40px; } }

        #splash { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .splash-logo { font-size: 3em; font-weight: 900; color:var(--primary-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .auth-box { background: var(--secondary-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 350px; text-align: center; }
        .password-wrapper { position: relative; }
        .toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.6; }

        #app-screen { display: none; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
        .main { flex: 1; background: var(--bg-color); position: relative; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .view { display: none; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; height: 100%; padding-bottom: 100px; box-sizing: border-box; }
        .view.active { display: block; }

        .nav-item { padding: 12px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; color: var(--text-color); gap: 15px; font-weight: 500; transition: 0.2s; }
        .nav-item:hover { background: rgba(0,0,0,0.05); }
        .nav-item.active { background: rgba(var(--primary-color), 0.1); color: var(--primary-color); font-weight: 700; }
        .badge { background: var(--notification-dot); width: 8px; height: 8px; border-radius: 50%; margin-left: auto; display: none;}

        .card { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 12px; }
        .avatar { border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .av-40 { width: 40px; height: 40px; }
        .av-80 { width: 80px; height: 80px; }
        .av-20 { width: 24px; height: 24px; margin-right: 5px; } 
        .user-row { display: flex; align-items: center; gap: 10px; }
        .pinned-chat { background-color: var(--pinned-bg); border-left: 3px solid var(--primary-color); }

        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
        .verified-badge { width: 16px; height: 16px; color: var(--verified-color); fill: currentColor; margin-left: 4px; vertical-align: text-bottom;}
        .status-pill { font-size: 11px; background: var(--status-bg); color: var(--status-text); padding: 2px 6px; border-radius: 6px; font-weight: bold; margin-left: 5px; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border-color); }
        .post-actions { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
        .act-btn { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; font-weight: 500; color: gray; }
        .act-btn.liked { color: var(--like-color); }
        .act-btn.liked svg { fill: var(--like-color); stroke: var(--like-color); }

        .top-post-banner { background: var(--top-post-bg); border: 2px solid gold; position: relative; overflow: hidden; }
        .top-label { position: absolute; top: 0; right: 0; background: gold; color: black; font-weight: bold; font-size: 10px; padding: 2px 8px; border-bottom-left-radius: 8px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; white-space: nowrap; font-size: 14px; }
        .tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
        .modal { background: var(--secondary-bg); width: 90%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.2em; font-weight: bold; }

        .comment-card { background: var(--input-bg); padding: 10px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; position: relative; }
        .comment-del { position: absolute; top: 5px; right: 5px; color: var(--danger-color); font-size: 12px; cursor: pointer; padding: 5px;}

        .msg-area { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
        .msg-row { display: flex; width: 100%; align-items: flex-end; position: relative; }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.other { justify-content: flex-start; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 15px; word-wrap: break-word; position: relative; }
        .msg.me { background: var(--message-out); border-bottom-right-radius: 4px; }
        .msg.other { background: var(--message-in); border-bottom-left-radius: 4px; }
        .msg.system { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; align-self: center; text-align: center; width: 90%; }
        .msg-del { font-size: 10px; color: #ff4444; cursor: pointer; margin-left: 5px; opacity: 0.7; align-self: center;}

        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; justify-content: space-around; border-top: 1px solid var(--border-color); padding: 0; z-index: 100; align-items: center; }
            .sidebar h2, .desk-label { display: none; }
            .nav-item { flex-direction: column; gap: 2px; padding: 5px; font-size: 10px; margin: 0; background: none !important; }
            #view-chat-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; padding: 0; display: none; flex-direction: column; }
            .fab { bottom: 70px; }
        }
    </style>
</head>
<body>

<div id="splash"><div class="splash-logo">Haskin</div></div>

<div id="auth-screen">
    <div class="auth-box" id="login-box">
        <h1 style="color:var(--primary-color)">–í—Ö–æ–¥</h1>
        <input type="text" id="login-user" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º">
        <div class="password-wrapper">
            <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <span class="toggle-pass" onclick="ui.togglePass('login-pass')">üëÅÔ∏è</span>
        </div>
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.login()">–í–æ–π—Ç–∏</button>
        <p style="cursor:pointer; color:gray" onclick="ui.toggleAuth('reg')">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
    </div>
    <div class="auth-box hidden" id="reg-box">
        <h1 style="color:var(--primary-color)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <input type="text" id="reg-user" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (–∞–Ω–≥–ª)">
        <input type="text" id="reg-name" placeholder="–ò–º—è">
        <div class="password-wrapper"><input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å"><span class="toggle-pass" onclick="ui.togglePass('reg-pass')">üëÅÔ∏è</span></div>
        <div class="password-wrapper"><input type="password" id="reg-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä –ø–∞—Ä–æ–ª—è"><span class="toggle-pass" onclick="ui.togglePass('reg-pass2')">üëÅÔ∏è</span></div>
        <div style="border:1px solid #ccc; padding:10px; border-radius:10px; margin:5px 0;">
            <small>–ö–∞–ø—á–∞: <span id="captcha-task"></span></small>
            <input type="number" id="reg-captcha" placeholder="–û—Ç–≤–µ—Ç">
        </div>
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.register()">–°–æ–∑–¥–∞—Ç—å</button>
        <p style="cursor:pointer; color:gray" onclick="ui.toggleAuth('login')">–ù–∞–∑–∞–¥</p>
    </div>
</div>

<div id="create-post-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–ù–æ–≤—ã–π –ø–æ—Å—Ç <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <p id="group-post-hint" style="font-size:12px; color:gray; margin-top:-10px; margin-bottom:10px; display:none;">–í –≥—Ä—É–ø–ø—É...</p>
        <textarea id="post-text" rows="4" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
        <div id="post-img-preview" class="hidden" style="position:relative; margin-bottom:10px;">
            <img id="preview-img-el" style="width:100%; border-radius:10px;">
            <div onclick="app.clearImg()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border-radius:50%; width:24px; height:24px; text-align:center; cursor:pointer;">√ó</div>
        </div>
        <div style="display:flex; justify-content:space-between;">
            <label class="action-btn btn-sec">üì∑<input type="file" hidden accept="image/*" onchange="app.handleImg(this)"></label>
            <button class="action-btn" onclick="app.createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>
</div>

<div id="create-group-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <input type="text" id="group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input type="text" id="group-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<div id="edit-group-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <div style="text-align:center; margin-bottom:10px">
            <img id="edit-group-av-prev" class="avatar av-80" src="https://via.placeholder.com/80">
            <br>
            <label class="action-btn btn-sec" style="margin-top:5px; font-size:12px; display:inline-block">
                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" hidden accept="image/*" onchange="app.handleAvatar(this, true)">
            </label>
        </div>
        <input type="text" id="edit-group-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input type="text" id="edit-group-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
        <input type="hidden" id="edit-group-id">
        <button class="action-btn" style="width:100%; margin-top:10px" onclick="app.saveGroupChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div id="comments-modal" class="modal-overlay">
    <div class="modal" style="height:70vh">
        <div class="modal-head">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <div id="comments-list" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å...">
            <button class="action-btn" onclick="app.sendComment()">‚û§</button>
        </div>
    </div>
</div>

<div id="verify-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è <span onclick="ui.closeModals()" style="cursor:pointer">√ó</span></div>
        <input id="v-real" placeholder="–§–ò–û / –õ–∏—á–Ω–æ—Å—Ç—å">
        <input id="v-links" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏">
        <textarea id="v-reason" placeholder="–ü–æ—á–µ–º—É –Ω—É–∂–Ω–∞ –≥–∞–ª–æ—á–∫–∞?"></textarea>
        <button class="action-btn" onclick="app.reqVerify()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div id="app-screen">
    <div class="fab" onclick="app.openCreatePost()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    </div>

    <div class="sidebar">
        <h2 style="color:var(--primary-color); margin-bottom:30px; padding-left:10px;" class="desk-label">Haskin</h2>
        <div class="nav-item active" onclick="ui.nav('feed')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="desk-label">–õ–µ–Ω—Ç–∞</span>
        </div>
        <div class="nav-item" onclick="ui.nav('search')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span class="desk-label">–ü–æ–∏—Å–∫</span>
        </div>
        <div class="nav-item" onclick="ui.nav('groups')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span class="desk-label">–ì—Ä—É–ø–ø—ã</span>
        </div>
        <div class="nav-item" onclick="ui.nav('chats')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span class="desk-label">–ß–∞—Ç—ã</span>
        </div>
        <div class="nav-item" onclick="ui.nav('notifs')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span class="desk-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            <div class="badge" id="notif-badge"></div>
        </div>
        <div class="nav-item" onclick="ui.nav('profile')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span class="desk-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="nav-item hidden" id="nav-admin" onclick="ui.nav('admin')">
            <svg class="icon" viewBox="0 0 24 24" style="stroke:red"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span class="desk-label" style="color:red">–ê–¥–º–∏–Ω–∫–∞</span>
        </div>
        <div class="nav-item" onclick="ui.nav('settings')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span class="desk-label">–ú–µ–Ω—é</span>
        </div>
    </div>

    <div class="main">
        <div id="view-feed" class="view active">
            <h2 style="padding:0 15px; color:var(--primary-color)">–õ–µ–Ω—Ç–∞</h2>
            <div id="feed-content"></div>
        </div>

        <div id="view-groups" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>–°–æ–æ–±—â–µ—Å—Ç–≤–∞</h2>
                <button class="action-btn" style="padding:5px 15px; font-size:12px;" onclick="document.getElementById('create-group-modal').style.display='flex'">+ –°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <input placeholder="–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø..." style="margin-bottom:10px;" oninput="app.searchGroup(this.value)">
            <div id="groups-list"></div>
        </div>

        <div id="view-search" class="view">
            <h2>–ü–æ–∏—Å–∫</h2>
            <input placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="app.search(this.value)">
            <div id="search-res" style="margin-top:10px;"></div>
        </div>

        <div id="view-profile" class="view">
            <div id="profile-head"></div>
            <div class="tabs" style="margin-top:10px; padding:0 15px;">
                <div class="tab active">–ü–æ—Å—Ç—ã</div>
            </div>
            <div id="profile-posts"></div>
        </div>

        <div id="view-chats" class="view">
            <h2>–ß–∞—Ç—ã</h2>
            <div id="chats-list"></div>
        </div>
        
        <div id="view-chat-room" class="view" style="padding:0; display:none; flex-direction:column; z-index:2000;">
            <div style="padding:10px; background:var(--secondary-bg); border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="app.navToChatProfile()">
                <button onclick="event.stopPropagation(); ui.nav('chats')" style="border:none; background:none; font-size:24px; color:var(--text-color);">‚Üê</button>
                <div style="display:flex; flex-direction:column;">
                    <b id="chat-title">User</b>
                    <span style="font-size:10px; color:gray;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è</span>
                </div>
            </div>
            <div id="msg-container" class="msg-area"></div>
            <div style="padding:10px; background:var(--secondary-bg); display:flex; gap:10px;">
                <input id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="action-btn" onclick="app.sendMsg()">‚û§</button>
            </div>
        </div>

        <div id="view-notifs" class="view">
            <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            <div id="notifs-list"></div>
        </div>

        <div id="view-settings" class="view">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button id="settings-admin-btn" class="action-btn hidden" style="background: red; width: 100%; margin-bottom: 20px;" onclick="ui.nav('admin')">üõ°Ô∏è –û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω–∫—É</button>
            <div class="tabs">
                <button class="tab active" onclick="ui.setTab('acc', this)">–ê–∫–∫–∞—É–Ω—Ç</button>
                <button class="tab" onclick="ui.setTab('ui', this)">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
                <button class="tab" onclick="ui.setTab('priv', this)">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</button>
            </div>
            <div id="set-acc" class="set-page">
                <div class="card">
                    <h3>–î–∞–Ω–Ω—ã–µ</h3>
                    <input id="edit-name" placeholder="–ò–º—è">
                    <textarea id="edit-bio" placeholder="–û —Å–µ–±–µ"></textarea>
                    <p>–°—Ç–∞—Ç—É—Å:</p>
                    <select id="edit-status"></select>
                    <label class="action-btn btn-sec" style="margin-top:10px">–ê–≤–∞—Ç–∞—Ä<input type="file" hidden accept="image/*" onchange="app.handleAvatar(this)"></label>
                    <button class="action-btn" style="margin-top:10px; width:100%" onclick="app.saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <div class="card">
                    <h3>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
                    <button class="action-btn" onclick="document.getElementById('verify-modal').style.display='flex'">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–∞–ª–æ—á–∫—É</button>
                </div>
                <button class="action-btn btn-danger" style="width:100%" onclick="app.logout()">–í—ã–π—Ç–∏</button>
            </div>
            <div id="set-ui" class="set-page hidden">
                <div class="card">
                    <label class="user-row">
                        <input type="checkbox" id="theme-switch" onchange="ui.theme()"> –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
                    </label>
                </div>
            </div>
            <div id="set-priv" class="set-page hidden">
                <div class="card">
                    <h3>–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h3>
                    <label class="user-row">
                        <input type="checkbox" id="private-switch" onchange="app.togglePrivate()"> üîí –ó–∞–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                    </label>
                </div>
                <div class="card">
                    <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                    <div class="password-wrapper"><input type="password" id="ch-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"><span class="toggle-pass" onclick="ui.togglePass('ch-pass')">üëÅÔ∏è</span></div>
                    <div class="password-wrapper"><input type="password" id="ch-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"><span class="toggle-pass" onclick="ui.togglePass('ch-pass2')">üëÅÔ∏è</span></div>
                    <button class="action-btn" onclick="app.changePass()">–°–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view">
            <h2 style="color:red">–ê–¥–º–∏–Ω–∫–∞</h2>
            <button class="action-btn btn-sec" onclick="ui.nav('settings')">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="tabs" style="margin-top:10px;">
                <button class="tab active" onclick="admin.tab('users')">–Æ–∑–µ—Ä—ã</button>
                <button class="tab" onclick="admin.tab('verify')">–ó–∞—è–≤–∫–∏</button>
                <button class="tab" onclick="admin.tab('words')">–§–∏–ª—å—Ç—Ä</button>
            </div>
            <div id="adm-content"></div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBCcBSZx6kAFGwTscJlfDuiQILGZDaVN4g",
    authDomain: "mysocnet-34ee9.firebaseapp.com",
    projectId: "mysocnet-34ee9",
    storageBucket: "mysocnet-34ee9.firebasestorage.app",
    messagingSenderId: "82449086862",
    appId: "1:82449086862:web:e77a61b33a54be97a00cdf",
    measurementId: "G-4Z2SMZS5N4"
};

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);

const ICONS = {
    like: '<svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
    comment: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    share: '<svg class="icon" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>',
    trash: '<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
    verify: '<svg class="verified-badge" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
    lock: '<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'
};

let currentUser = null;
let listeners = {};
let tempImg = null;
let tempAv = null;
let curChat = null;
let curChatAvatar = '';
let curPost = null;
let captchaAns = 0;
let lastPostTime = 0;
let activeChatUnsub = null;
let forbiddenWords = [];
let activeGroupId = null; // New logic for group posts

const compress = (file, cb) => {
    const r = new FileReader(); r.readAsDataURL(file);
    r.onload = e => {
        const i = new Image(); i.src = e.target.result;
        i.onload = () => {
            const c = document.createElement('canvas');
            const max = 800; let w=i.width, h=i.height;
            if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
            c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h);
            cb(c.toDataURL('image/jpeg', 0.8));
        }
    }
};
const getAv = (u, sz) => `<img src="${u.avatar||'https://via.placeholder.com/80'}" class="avatar ${sz}">`;

window.ui = {
    nav: (v, p) => {
        if(activeChatUnsub) { activeChatUnsub(); activeChatUnsub = null; }
        if(v === 'profile' && !p) { if(currentUser) p = currentUser.username; else return; }
        
        // Reset group state unless we are navigating to a profile (which might be a group)
        if(v !== 'profile') activeGroupId = null;

        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        const el = document.getElementById('view-'+(v==='admin'?'admin':v));
        if(el) el.classList.add('active');
        
        const map = {'feed':0, 'search':1, 'groups':2, 'chats':3, 'notifs':4, 'profile':5, 'settings':6};
        if(map[v]!==undefined) document.querySelectorAll('.nav-item')[map[v]].classList.add('active');
        if(v==='chat-room') document.getElementById('view-chat-room').style.display = 'flex';
        else document.getElementById('view-chat-room').style.display = 'none';
        
        if(v==='feed') app.loadFeed();
        if(v==='chats') app.loadChats();
        if(v==='groups') app.loadGroups();
        if(v==='notifs') app.listenNotifs();
        if(v==='profile') app.loadProfile(p);
        if(v==='chat-room') app.loadChatRoom(p);
        if(v==='admin') admin.tab('users');
        if(v==='settings' && currentUser.isAdmin) document.getElementById('settings-admin-btn').classList.remove('hidden');
    },
    toggleAuth: m => {
        document.getElementById('login-box').classList.toggle('hidden', m!=='login');
        document.getElementById('reg-box').classList.toggle('hidden', m!=='reg');
        if(m==='reg') app.genCaptcha();
    },
    togglePass: id => {
        const el = document.getElementById(id);
        el.type = el.type==='password'?'text':'password';
    },
    closeModals: () => document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'),
    theme: () => {
        const d = document.getElementById('theme-switch').checked;
        document.documentElement.setAttribute('data-theme', d?'dark':'');
        localStorage.setItem('theme', d?'dark':'');
    },
    setTab: (t, btn) => {
        document.querySelectorAll('.set-page').forEach(e=>e.classList.add('hidden'));
        document.getElementById('set-'+t).classList.remove('hidden');
        btn.parentElement.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        btn.classList.add('active');
    }
};

window.app = {
    init: async () => {
        if(localStorage.getItem('theme')==='dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-switch').checked = true;
        }
        try {
            const u = localStorage.getItem('user');
            if(u) {
                const s = await getDoc(doc(db, 'users', u));
                if(s.exists()) {
                    currentUser = s.data();
                    currentUser.blocked = currentUser.blocked || [];
                    currentUser.blockedBy = currentUser.blockedBy || [];
                    currentUser.pinnedChats = currentUser.pinnedChats || [];
                    currentUser.groups = currentUser.groups || [];
                    
                    if(currentUser.isBanned) throw new Error('Banned');
                    
                    const conf = await getDoc(doc(db, 'system', 'config'));
                    if(conf.exists()) forbiddenWords = conf.data().words || [];

                    document.getElementById('auth-screen').style.display='none';
                    document.getElementById('app-screen').style.display='block';
                    if(currentUser.isAdmin) document.getElementById('nav-admin').classList.remove('hidden');
                    ui.nav('feed');
                    app.checkAchievs();
                } else throw new Error('No User');
            } else throw new Error('No Local User');
        } catch(e) {
            if(e.message === 'Banned') alert('–ë–∞–Ω');
            localStorage.clear();
            ui.toggleAuth('login');
        } finally {
            setTimeout(() => { document.getElementById('splash').style.display='none'; }, 500);
        }
    },

    genCaptcha: () => {
        const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10);
        captchaAns = a+b;
        document.getElementById('captcha-task').innerText = `${a} + ${b}`;
    },

    register: async () => {
        const u = document.getElementById('reg-user').value.toLowerCase().trim();
        const n = document.getElementById('reg-name').value.trim();
        const p1 = document.getElementById('reg-pass').value;
        const p2 = document.getElementById('reg-pass2').value;
        const c = parseInt(document.getElementById('reg-captcha').value);
        if(!u || !n || !p1) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        if(p1!==p2) return alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        if(c!==captchaAns) return alert('–ö–∞–ø—á–∞ –Ω–µ–≤–µ—Ä–Ω–∞');
        try {
            const r = doc(db, 'users', u);
            if((await getDoc(r)).exists()) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç');
            await setDoc(r, { username: u, name: n, password: p1, followers: [], following: [], blocked: [], isAdmin: u==='haskin', isBanned: false, isMuted: false, requests: [], groups: [], bio: '', status: '', avatar: '', createdAt: Date.now() });
            alert('–ì–æ—Ç–æ–≤–æ'); ui.toggleAuth('login');
        } catch(e) { alert('–û—à–∏–±–∫–∞'); }
    },

    login: async () => {
        const u = document.getElementById('login-user').value.toLowerCase().trim();
        const p = document.getElementById('login-pass').value;
        const s = await getDoc(doc(db, 'users', u));
        if(s.exists() && s.data().password === p) {
            if(s.data().isBanned) return alert('–ë–∞–Ω');
            localStorage.setItem('user', u);
            location.reload();
        } else alert('–ù–µ–≤–µ—Ä–Ω–æ');
    },
    logout: () => { localStorage.clear(); location.reload(); },

    checkContent: (txt) => {
        if(!txt) return true;
        const lower = txt.toLowerCase();
        for(let w of forbiddenWords) {
            if(lower.includes(w.toLowerCase())) { alert(`–°–ª–æ–≤–æ "${w}" –∑–∞–ø—Ä–µ—â–µ–Ω–æ`); return false; }
        }
        return true;
    },

    openCreatePost: () => {
        document.getElementById('group-post-hint').style.display = activeGroupId ? 'block' : 'none';
        if(activeGroupId) document.getElementById('group-post-hint').innerText = "–í –≥—Ä—É–ø–ø—É: " + activeGroupId;
        document.getElementById('create-post-modal').style.display='flex';
    },

    createPost: async () => {
        if(currentUser.isMuted) return alert("–í—ã –∑–∞–º—å—é—á–µ–Ω—ã!");
        if(Date.now()-lastPostTime < 5000) return alert('–ù–µ —Å–ø–µ—à–∏!');
        const txt = document.getElementById('post-text').value.trim();
        if(!app.checkContent(txt)) return;
        if(!txt && !tempImg) return;
        const p = { 
            author: currentUser.username, 
            name: currentUser.name, 
            content: txt, 
            image: tempImg || null, 
            likes: [], 
            createdAt: Date.now(), 
            verified: currentUser.isVerified || false, 
            status: currentUser.status || '', 
            avatar: currentUser.avatar || ''
        };
        // Group Logic
        if(activeGroupId) p.groupId = activeGroupId;

        await addDoc(collection(db, 'posts'), p);
        lastPostTime = Date.now();
        document.getElementById('post-text').value='';
        app.clearImg(); ui.closeModals();
        
        // Refresh feed if in group
        if(activeGroupId) app.loadProfile(activeGroupId);
        else app.checkAchievs();
    },

    repost: async (postId) => {
        if(currentUser.isMuted) return alert("–í—ã –∑–∞–º—å—é—á–µ–Ω—ã!");
        if(!confirm('–†–µ–ø–æ—Å—Ç–Ω—É—Ç—å?')) return;
        const orig = (await getDoc(doc(db, 'posts', postId))).data();
        await addDoc(collection(db, 'posts'), { author: currentUser.username, name: currentUser.name, content: `üì¢ –†–µ–ø–æ—Å—Ç –æ—Ç @${orig.author}:\n\n${orig.content}`, image: orig.image, likes: [], createdAt: Date.now(), verified: currentUser.isVerified, status: currentUser.status, avatar: currentUser.avatar, isRepost: true });
        alert('–†–µ–ø–æ—Å—Ç–Ω—É—Ç!');
    },

    loadFeed: async () => {
        const c = document.getElementById('feed-content'); c.innerHTML = '';
        const yesterday = Date.now() - 86400000;
        const qTop = query(collection(db, 'posts'), where('createdAt', '>', yesterday), orderBy('createdAt', 'desc')); 
        const snaps = await getDocs(qTop);
        let topPost = null; let maxLikes = -1;
        snaps.forEach(d => { const p = d.data(); p.id = d.id; if(!p.groupId && p.likes && p.likes.length > maxLikes) { maxLikes = p.likes.length; topPost = p; } });
        if(topPost && maxLikes > 0) c.innerHTML += app.renderPost(topPost, true);
        
        if(listeners.feed) listeners.feed();
        const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(50));
        listeners.feed = onSnapshot(q, s => {
            const topHtml = topPost && maxLikes > 0 ? app.renderPost(topPost, true) : '';
            let html = topHtml;
            s.forEach(d => {
                const p = d.data(); p.id = d.id;
                if(p.groupId) return; // Don't show group posts in main feed
                if(currentUser.blocked.includes(p.author)) return;
                if(topPost && p.id === topPost.id) return;
                html += app.renderPost(p);
            });
            c.innerHTML = html;
        });
    },

    renderPost: (p, isTop=false) => {
        const likes = p.likes || [];
        const isLiked = likes.includes(currentUser.username);
        const isMine = p.author === currentUser.username;
        return `<div class="card ${isTop?'top-post-banner':''}">
            ${isTop ? '<div class="top-label">üëë –¢–û–ü –î–ù–Ø</div>' : ''}
            <div class="post-header" onclick="ui.nav('profile','${p.author}')">
                ${getAv(p, 'av-40')}
                <div><div style="font-weight:bold; display:flex; align-items:center;">${p.name} ${p.verified?ICONS.verify:''} ${p.status?`<span class="status-pill">${p.status}</span>`:''}</div>
                <div style="font-size:12px; color:gray">@${p.author} ‚Ä¢ ${new Date(p.createdAt).toLocaleDateString()}</div></div>
            </div>
            <div style="white-space:pre-wrap">${p.content}</div>
            ${p.image ? `<img src="${p.image}" class="post-img">` : ''}
            <div class="post-actions">
                <div class="act-btn ${isLiked?'liked':''}" onclick="app.like('${p.id}', '${p.author}')">${ICONS.like} ${likes.length}</div>
                <div class="act-btn" onclick="app.openComs('${p.id}', '${p.author}')">${ICONS.comment}</div>
                <div class="act-btn" onclick="app.repost('${p.id}')">${ICONS.share}</div>
                ${isMine || currentUser.isAdmin ? `<div class="act-btn" style="margin-left:auto; color:red" onclick="app.delPost('${p.id}')">${ICONS.trash}</div>` : ''}
            </div>
        </div>`;
    },

    loadProfile: async (u) => {
        const c = document.getElementById('profile-head');
        c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        
        // Reset Active Group logic
        activeGroupId = null;

        const s = await getDoc(doc(db, 'users', u));
        if(s.exists()) { 
            const user = s.data();
            const isMe = u === currentUser.username;
            const isFollow = currentUser.following.includes(u);
            const isBlocked = currentUser.blocked.includes(u);
            const isClosed = user.isPrivate && !isMe && !isFollow;
            
            let btn = '';
            if(isMe) btn = `<button class="action-btn" onclick="ui.nav('settings')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
            else {
                if(isBlocked) btn = `<button class="action-btn btn-sec" onclick="app.blockUser('${u}', false)">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
                else {
                    if(isFollow) btn = `<button class="action-btn btn-sec" onclick="app.follow('${u}')">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button> <button class="action-btn" onclick="ui.nav('chat-room','${u}')">–ß–∞—Ç</button>`;
                    else if (user.isPrivate) {
                        const sent = user.requests && user.requests.includes(currentUser.username);
                        btn = `<button class="action-btn" onclick="app.reqFollow('${u}')">${sent?'–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω':'üîí –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É'}</button>`;
                    } else btn = `<button class="action-btn" onclick="app.follow('${u}')">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>`;
                    btn += `<br><button class="action-btn btn-danger" style="margin-top:5px; font-size:12px;" onclick="app.blockUser('${u}', true)">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
                }
            }

            c.innerHTML = `<div class="card" style="text-align:center">${getAv(user, 'av-80')}
                <h2 style="margin:5px 0">${user.name} ${user.isVerified?ICONS.verify:''}</h2>
                <div style="color:gray">@${user.username} ${user.status?`‚Ä¢ <span class="status-pill">${user.status}</span>`:''}</div>
                <p>${user.bio||''}</p>
                <div style="display:flex; justify-content:center; gap:20px; margin:10px 0;">
                    <b>${user.followers.length} <span style="font-weight:normal; color:gray">–ø–æ–¥–ø.</span></b>
                    <b>${user.following.length} <span style="font-weight:normal; color:gray">–ø–æ–¥–ø–∏—Å–∫–∏</span></b>
                </div>${btn}</div>`;

            const pc = document.getElementById('profile-posts');
            if(isClosed || isBlocked) {
                pc.innerHTML = `<div style="text-align:center; padding:20px; color:gray">${ICONS.lock}<br>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>`;
            } else {
                const q = query(collection(db, 'posts'), where('author', '==', u), orderBy('createdAt', 'desc'));
                const ps = await getDocs(q);
                pc.innerHTML = '';
                ps.forEach(d => {
                    const p = d.data();
                    if(!p.groupId) pc.innerHTML += app.renderPost({...p, id:d.id});
                });
            }
        } else {
            // Group Logic
            const g = await getDoc(doc(db, 'groups', u));
            if(g.exists()) {
                activeGroupId = u; // SET GROUP CONTEXT
                const group = g.data();
                const isMem = group.members.includes(currentUser.username);
                const isOwner = group.owner === currentUser.username;
                const ownerControls = isOwner ? `<div style="display:flex; gap:5px; justify-content:center; margin-top:10px;"><button class="action-btn btn-sec" style="font-size:12px;" onclick="app.editGroup('${u}')">‚úèÔ∏è</button><button class="action-btn btn-danger" style="font-size:12px;" onclick="app.deleteGroup('${u}')">üóëÔ∏è</button></div>` : '';
                c.innerHTML = `<div class="card" style="text-align:center"><div class="avatar av-80" style="background:${varColor(group.name)}; display:inline-flex; align-items:center; justify-content:center; font-size:30px; color:white;">${group.avatar ? `<img src="${group.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : group.name[0]}</div><h2>${group.name}</h2><p>${group.desc}</p><p style="color:gray">${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>${isMem ? `<button class="action-btn btn-sec" onclick="app.joinGroup('${u}', false)">–í—ã–π—Ç–∏</button>` : `<button class="action-btn" onclick="app.joinGroup('${u}', true)">–í—Å—Ç—É–ø–∏—Ç—å</button>`}${ownerControls}</div>`;
                 
                // Load Group Posts
                const q = query(collection(db, 'posts'), where('groupId', '==', u), orderBy('createdAt', 'desc'));
                const ps = await getDocs(q);
                const pc = document.getElementById('profile-posts');
                pc.innerHTML = '';
                if(isMem) pc.innerHTML = `<button class="action-btn" style="width:100%; margin-bottom:10px" onclick="app.openCreatePost()">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø—É</button>`;
                ps.forEach(d => pc.innerHTML += app.renderPost({...d.data(), id:d.id}));
            } else c.innerHTML = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
        }
    },

    searchGroup: async (v) => {
        if(!v) { app.loadGroups(); return; }
        v = v.toLowerCase();
        const c = document.getElementById('groups-list'); c.innerHTML='';
        const q = query(collection(db, 'groups'), orderBy('name'), limit(20)); // Simple scan as firestore regex is hard
        const s = await getDocs(q);
        s.forEach(d => {
            const g = d.data();
            if(g.name.toLowerCase().includes(v)) {
                const avHtml = g.avatar ? `<img src="${g.avatar}" class="avatar av-40">` : `<div class="avatar av-40" style="background:${varColor(g.name)}; display:flex; align-items:center; justify-content:center; color:white;">${g.name[0]}</div>`;
                c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${g.id}')">${avHtml}<div><b>${g.name}</b><br><small>${g.members.length} —É—á.</small></div></div>`;
            }
        });
    },

    blockUser: async (target, doBlock) => {
        const ref = doc(db, 'users', currentUser.username);
        if(doBlock) {
            if(!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?')) return;
            await updateDoc(ref, { blocked: arrayUnion(target) });
            await updateDoc(doc(db, 'users', target), { blockedBy: arrayUnion(currentUser.username) });
            alert('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
        } else {
            await updateDoc(ref, { blocked: arrayRemove(target) });
            await updateDoc(doc(db, 'users', target), { blockedBy: arrayRemove(currentUser.username) });
            alert('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
        }
        ui.nav('profile', target);
    },

    createGroup: async () => {
        const n = document.getElementById('group-name').value.trim();
        const d = document.getElementById('group-desc').value;
        const id = 'public_' + Date.now();
        await setDoc(doc(db, 'groups', id), { id, name: n, desc: d, owner: currentUser.username, members: [currentUser.username], avatar: '' });
        await updateDoc(doc(db, 'users', currentUser.username), { groups: arrayUnion(id) });
        ui.closeModals(); ui.nav('groups');
    },
    loadGroups: async () => {
        const c = document.getElementById('groups-list'); c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const q = query(collection(db, 'groups'), limit(20));
        const s = await getDocs(q);
        c.innerHTML = '';
        s.forEach(d => { const g = d.data(); const avHtml = g.avatar ? `<img src="${g.avatar}" class="avatar av-40">` : `<div class="avatar av-40" style="background:${varColor(g.name)}; display:flex; align-items:center; justify-content:center; color:white;">${g.name[0]}</div>`; c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${g.id}')">${avHtml}<div><b>${g.name}</b><br><small>${g.members.length} —É—á.</small></div></div>`; });
    },
    joinGroup: async (gid, join) => {
        const ref = doc(db, 'groups', gid);
        if(join) await updateDoc(ref, { members: arrayUnion(currentUser.username) });
        else await updateDoc(ref, { members: arrayRemove(currentUser.username) });
        ui.nav('profile', gid);
    },
    editGroup: async (gid) => {
        const g = (await getDoc(doc(db, 'groups', gid))).data();
        document.getElementById('edit-group-name').value = g.name; document.getElementById('edit-group-desc').value = g.desc;
        document.getElementById('edit-group-id').value = gid; document.getElementById('edit-group-av-prev').src = g.avatar || 'https://via.placeholder.com/80';
        tempAv = null; document.getElementById('edit-group-modal').style.display = 'flex';
    },
    saveGroupChanges: async () => {
        const gid = document.getElementById('edit-group-id').value; const upd = { name:document.getElementById('edit-group-name').value, desc:document.getElementById('edit-group-desc').value };
        if(tempAv) upd.avatar = tempAv;
        await updateDoc(doc(db, 'groups', gid), upd); ui.closeModals(); ui.nav('profile', gid);
    },
    deleteGroup: async (gid) => { if(!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) return; await deleteDoc(doc(db, 'groups', gid)); alert('–£–¥–∞–ª–µ–Ω–∞'); ui.nav('groups'); },
    
    // --- CHATS ---
    loadChats: async () => {
        const c = document.getElementById('chats-list'); c.innerHTML='–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        const friends = currentUser.following; 
        const pinned = currentUser.pinnedChats || [];
        
        let chatsData = [];
        for(const f of friends) {
             const u = await getDoc(doc(db, 'users', f));
             if(!u.exists()) continue;
             const ud = u.data();
             if(ud.following.includes(currentUser.username)) {
                 const chatId = [currentUser.username, f].sort().join('_');
                 const meta = await getDoc(doc(db, 'chats', chatId));
                 const lastMsg = meta.exists() ? (meta.data().lastMessage || '–ù–∞–ø–∏—Å–∞—Ç—å...') : '–ù–∞–ø–∏—Å–∞—Ç—å...';
                 const lastTime = meta.exists() ? (meta.data().lastTime || 0) : 0;
                 chatsData.push({ id: f, user: ud, lastMsg, lastTime });
             }
        }
        chatsData.sort((a,b) => {
            const aPin = pinned.includes(a.id); const bPin = pinned.includes(b.id);
            if(aPin && !bPin) return -1; if(!aPin && bPin) return 1;
            return b.lastTime - a.lastTime;
        });
        c.innerHTML = '';
        if(chatsData.length===0) c.innerHTML='<p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å</p>';
        chatsData.forEach(ch => {
            const isPin = pinned.includes(ch.id);
            c.innerHTML += `<div class="card user-row ${isPin?'pinned-chat':''}" style="justify-content:space-between">
                <div class="user-row" onclick="ui.nav('chat-room','${ch.id}')" style="flex:1">
                    ${getAv(ch.user, 'av-40')} 
                    <div><b>${ch.user.name} ${isPin?'üìå':''}</b><div style="font-size:12px; color:gray; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:150px;">${ch.lastMsg}</div></div>
                </div>
                <button class="action-btn btn-sec" style="padding:5px" onclick="app.pinChat('${ch.id}')">${isPin?'‚ùå':'üìå'}</button>
            </div>`;
        });
    },
    pinChat: async (target) => {
        if(currentUser.pinnedChats.includes(target)) await updateDoc(doc(db, 'users', currentUser.username), { pinnedChats: arrayRemove(target) });
        else await updateDoc(doc(db, 'users', currentUser.username), { pinnedChats: arrayUnion(target) });
        location.reload(); 
    },
    loadChatRoom: async (partner) => {
        document.getElementById('chat-title').innerText = partner;
        curChat = partner;
        const u = await getDoc(doc(db, 'users', partner));
        curChatAvatar = u.exists() ? (u.data().avatar || '') : '';
        const chatId = [currentUser.username, partner].sort().join('_');
        const c = document.getElementById('msg-container');
        if(activeChatUnsub) activeChatUnsub();
        const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('time', 'asc'), limit(50));
        activeChatUnsub = onSnapshot(q, s => {
            c.innerHTML = '';
            s.forEach(d => {
                const m = d.data();
                const isMe = m.from === currentUser.username;
                const isSys = m.from === 'System';
                let html = '';
                if(isSys) html = `<div class="msg system">${m.text}</div>`;
                else {
                    // Chat delete
                    const delBtn = isMe ? `<span class="msg-del" onclick="app.delMsg('${d.id}','${chatId}')">√ó</span>` : '';
                    html = `<div class="msg-row ${isMe?'me':'other'}">${!isMe ? `<img src="${curChatAvatar||'https://via.placeholder.com/20'}" class="avatar av-20">` : ''}<div class="msg ${isMe?'me':'other'}">${m.text}</div>${delBtn}</div>`;
                }
                c.innerHTML += html;
            });
            c.scrollTop = c.scrollHeight;
        });
    },
    sendMsg: async () => {
        const txt = document.getElementById('msg-input').value.trim();
        if(!txt || !curChat) return;
        if(currentUser.isMuted) return alert("–ú—É—Ç!");
        if(currentUser.blocked.includes(curChat)) return alert("–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞");
        if(!app.checkContent(txt)) return;
        
        const chatId = [currentUser.username, curChat].sort().join('_');
        await addDoc(collection(db, 'chats', chatId, 'messages'), { from: currentUser.username, text: txt, time: Date.now() });
        await setDoc(doc(db, 'chats', chatId), { lastMessage: txt, lastTime: Date.now() }, { merge: true });
        document.getElementById('msg-input').value = '';
    },
    delMsg: async (id, chatId) => {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
        await deleteDoc(doc(db, 'chats', chatId, 'messages', id));
    },
    navToChatProfile: () => { ui.nav('profile', curChat); },

    // --- Actions ---
    like: async (pid, auth) => {
        const r = doc(db, 'posts', pid); const p = (await getDoc(r)).data();
        if(p.likes.includes(currentUser.username)) await updateDoc(r, {likes: arrayRemove(currentUser.username)});
        else { await updateDoc(r, {likes: arrayUnion(currentUser.username)}); app.notify(auth, 'like', '–æ—Ü–µ–Ω–∏–ª –ø–æ—Å—Ç'); }
    },
    follow: async (u) => {
        if(currentUser.blocked.includes(u)) return alert("–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ");
        const me = doc(db, 'users', currentUser.username); const him = doc(db, 'users', u);
        if(currentUser.following.includes(u)) { await updateDoc(me, {following: arrayRemove(u)}); await updateDoc(him, {followers: arrayRemove(currentUser.username)}); currentUser.following = currentUser.following.filter(x=>x!==u); }
        else { await updateDoc(me, {following: arrayUnion(u)}); await updateDoc(him, {followers: arrayUnion(currentUser.username)}); currentUser.following.push(u); app.notify(u, 'sub', '–ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ –≤–∞—Å'); }
        ui.nav('profile', u); app.checkAchievs();
    },
    reqFollow: async (u) => { await updateDoc(doc(db, 'users', u), { requests: arrayUnion(currentUser.username) }); app.notify(u, 'req', '—Ö–æ—á–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'); alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'); ui.nav('profile', u); },
    acceptReq: async (u) => { await updateDoc(doc(db, 'users', currentUser.username), { requests: arrayRemove(u), followers: arrayUnion(u) }); await updateDoc(doc(db, 'users', u), { following: arrayUnion(currentUser.username) }); app.notify(u, 'msg', '–ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É'); app.listenNotifs(); },
    
    openComs: (pid, auth) => {
        curPost = pid; document.getElementById('comments-modal').style.display='flex'; const list = document.getElementById('comments-list');
        const q = query(collection(db, 'posts', pid, 'comments'), orderBy('time', 'asc'));
        onSnapshot(q, s => { 
            list.innerHTML=''; 
            s.forEach(d => { 
                const c = d.data(); 
                const isMine = c.author === currentUser.username || currentUser.isAdmin || auth === currentUser.username;
                const del = isMine ? `<span class="comment-del" onclick="app.delComment('${d.id}')">√ó</span>` : '';
                list.innerHTML += `<div class="comment-card"><b>${c.author}</b><br>${c.text}${del}</div>`; 
            }); 
        });
    },
    sendComment: async () => { if(currentUser.isMuted) return alert("–ú—É—Ç!"); const t = document.getElementById('comment-input').value; if(!t) return; if(!app.checkContent(t)) return; await addDoc(collection(db, 'posts', curPost, 'comments'), { author: currentUser.username, text: t, time: Date.now() }); document.getElementById('comment-input').value=''; },
    delComment: async (id) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) await deleteDoc(doc(db,'posts',curPost,'comments',id)); },
    delPost: async (id) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) await deleteDoc(doc(db,'posts',id)); },

    // --- Misc ---
    handleImg: el => { if(el.files[0]) compress(el.files[0], d=>{ tempImg=d; document.getElementById('preview-img-el').src=d; document.getElementById('post-img-preview').classList.remove('hidden'); }) },
    clearImg: () => { tempImg=null; document.getElementById('post-img-preview').classList.add('hidden'); },
    handleAvatar: (el, isGroup=false) => { if(el.files[0]) compress(el.files[0], d=>{ tempAv=d; if(isGroup) document.getElementById('edit-group-av-prev').src = d; }) },
    
    saveProfile: async () => { const n = document.getElementById('edit-name').value; const b = document.getElementById('edit-bio').value; const s = document.getElementById('edit-status').value; const upd = { name:n, bio:b, status:s }; if(tempAv) upd.avatar = tempAv; await updateDoc(doc(db, 'users', currentUser.username), upd); location.reload(); },
    togglePrivate: async () => { const v = document.getElementById('private-switch').checked; await updateDoc(doc(db, 'users', currentUser.username), { isPrivate: v }); },
    changePass: async () => { const p1 = document.getElementById('ch-pass').value; const p2 = document.getElementById('ch-pass2').value; if(!p1) return; if(p1 !== p2) return alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!"); await updateDoc(doc(db, 'users', currentUser.username), { password: p1 }); alert('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω'); },
    checkAchievs: async () => { const u = currentUser; const unlocked = u.unlocked || []; const posts = (await getDocs(query(collection(db,'posts'), where('author','==',u.username)))).size; const map = { '–ê–∫—Ç–∏–≤–Ω—ã–π': posts>=5, '–ü–∏—Å–∞—Ç–µ–ª—å': posts>=50, '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π': u.followers.length>=10 }; let ch = false; for(let k in map) { if(map[k] && !unlocked.includes(k)) { unlocked.push(k); ch=true; app.notify(u.username, 'msg', `üèÜ –°—Ç–∞—Ç—É—Å: ${k}`); } } if(ch) await updateDoc(doc(db, 'users', u.username), { unlocked }); const sel = document.getElementById('edit-status'); sel.innerHTML = '<option value="">–ù–µ—Ç</option>'; unlocked.forEach(s => sel.innerHTML += `<option>${s}</option>`); sel.value = u.status; },
    search: async (v) => { if(!v) return; v = v.toLowerCase(); const q = query(collection(db, 'users'), where('username', '>=', v), limit(5)); const s = await getDocs(q); const c = document.getElementById('search-res'); c.innerHTML=''; s.forEach(d => { const u = d.data(); c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${u.username}')">${getAv(u,'av-40')} <b>${u.name}</b></div>`; }); },
    notify: async (to, type, txt) => { if(to === currentUser.username) return; await addDoc(collection(db, 'users', to, 'notifications'), { type, text: txt, from: currentUser.username, time: Date.now(), read: false }); },
    listenNotifs: () => { const q = query(collection(db, 'users', currentUser.username, 'notifications'), orderBy('time', 'desc'), limit(20)); onSnapshot(q, s => { let n = 0; s.forEach(d => { if(!d.data().read) n++ }); document.getElementById('notif-badge').style.display = n?'block':'none'; if(document.getElementById('view-notifs').classList.contains('active')) { const c = document.getElementById('notifs-list'); c.innerHTML=''; s.forEach(d => { const x = d.data(); let act = ''; if(x.type === 'req') act = `<button class="action-btn" style="font-size:12px; padding:5px" onclick="app.acceptReq('${x.from}')">–ü—Ä–∏–Ω—è—Ç—å</button>`; c.innerHTML += `<div class="card user-row" onclick="ui.nav('profile','${x.from}')">${ICONS.lock} <div><b>@${x.from}</b> ${x.text}</div> ${act}</div>`; }); } }); },
    reqVerify: async () => { await addDoc(collection(db,'system','verifications','requests'), { username: currentUser.username, realname: document.getElementById('v-real').value, reason: document.getElementById('v-reason').value, status: 'pending' }); alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'); ui.closeModals(); }
};

window.admin = {
    tab: t => {
        const c = document.getElementById('adm-content');
        const b = document.querySelectorAll('.view#view-admin .tab');
        b.forEach(el => el.classList.remove('active'));
        if(t==='users') { b[0].classList.add('active'); c.innerHTML = '<input oninput="admin.s(this.value)" placeholder="–ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞..."><div id="adm-list"></div>'; }
        if(t==='verify') { b[1].classList.add('active'); admin.loadV(); }
        if(t==='words') { b[2].classList.add('active'); admin.loadW(); }
    },
    s: async v => {
        const s = await getDocs(query(collection(db,'users'), where('username','>=',v), limit(5)));
        const c = document.getElementById('adm-list'); c.innerHTML='';
        s.forEach(d=> { const u = d.data(); c.innerHTML += `<div class="card"><b>${u.username}</b><br><button class="action-btn btn-danger" onclick="admin.ban('${u.username}')">${u.isBanned?'–†–∞–∑–±–∞–Ω':'–ë–∞–Ω'}</button> <button class="action-btn btn-sec" onclick="admin.mute('${u.username}')">${u.isMuted?'Unmute':'Mute'}</button> <button class="action-btn" onclick="admin.warn('${u.username}')">–í–∞—Ä–Ω</button></div>`; });
    },
    loadV: async () => { const s = await getDocs(query(collection(db,'system','verifications','requests'), where('status','==','pending'))); const c = document.getElementById('adm-content'); c.innerHTML = ''; if(s.empty) c.innerHTML='–ù–µ—Ç –∑–∞—è–≤–æ–∫'; s.forEach(d => { const r = d.data(); c.innerHTML += `<div class="card"><b>${r.username}</b>: ${r.realname}<br>${r.reason}<br><div style="margin-top:10px"><button class="action-btn" onclick="admin.okV('${d.id}','${r.username}')">‚úÖ</button> <button class="action-btn btn-danger" onclick="admin.noV('${d.id}')">‚ùå</button></div></div>`; }); },
    loadW: () => {
        document.getElementById('adm-content').innerHTML = `<h3>–§–∏–ª—å—Ç—Ä —Å–ª–æ–≤</h3><p>–†–∞–∑–¥–µ–ª—è–π—Ç–µ –∑–∞–ø—è—Ç—ã–º–∏</p><textarea id="adm-words" rows="5">${forbiddenWords.join(', ')}</textarea><button class="action-btn" style="margin-top:10px" onclick="admin.saveW()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
    },
    saveW: async () => {
        const txt = document.getElementById('adm-words').value;
        const arr = txt.split(',').map(w => w.trim()).filter(w => w);
        await setDoc(doc(db, 'system', 'config'), { words: arr }, { merge: true });
        alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); forbiddenWords = arr;
    },
    okV: async (id, u) => { await updateDoc(doc(db,'users',u), {isVerified:true}); await updateDoc(doc(db,'system','verifications','requests',id), {status:'approved'}); alert('OK'); admin.loadV(); },
    noV: async (id) => { if(!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å?')) return; await updateDoc(doc(db,'system','verifications','requests',id), {status:'rejected'}); alert('–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'); admin.loadV(); },
    ban: async u => { if(confirm('–ë–∞–Ω/–†–∞–∑–±–∞–Ω?')) { const curr = (await getDoc(doc(db,'users',u))).data().isBanned; await updateDoc(doc(db,'users',u), {isBanned:!curr}); } },
    mute: async u => { const curr = (await getDoc(doc(db,'users',u))).data().isMuted; await updateDoc(doc(db,'users',u), {isMuted:!curr}); alert('Done'); },
    warn: async u => { const r = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤–∞—Ä–Ω–∞:'); if(!r) return; const chatId = ['System', u].sort().join('_'); await addDoc(collection(db, 'chats', chatId, 'messages'), { from: 'System', text: "‚ö†Ô∏è –í–ê–†–ù: "+r, time: Date.now() }); await addDoc(collection(db, 'users', u, 'notifications'), { type: 'msg', text: '–ü–æ–ª—É—á–∏–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!', from: 'System', time: Date.now(), read: false }); alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }
};

const varColor = (str) => { let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); return `hsl(${hash % 360}, 60%, 50%)`; }

app.init();
</script>
</body>
</html>
